/**
 * [Chart.PieceLabel.js]{@link https://github.com/emn178/Chart.PieceLabel.js}
 *
 * @version 0.14.0
 * @author Chen, Yi-Cyuan [emn178@gmail.com]
 * @copyright Chen, Yi-Cyuan 2017-2018
 * @license MIT
 */
(function(){function p(){this.drawDataset=this.drawDataset.bind(this)}function v(a,c){if(a.options.pieceLabel){var b=1;Array.isArray(a.options.pieceLabel)&&(b=a.options.pieceLabel.length);if(!a.pieceLabel||b!==a.pieceLabel.length){a.pieceLabel=[];for(var g=0;g<b;++g)a.pieceLabel.push(new p)}}else a.pieceLabel&&delete a.pieceLabel;if(a.pieceLabel)for(b=0;b<a.pieceLabel.length;++b)a.pieceLabel[b][c](a,b)}"undefined"===typeof Chart?console.warn("Can not find Chart object."):(Array.isArray||(Array.isArray=
function(a){return"[object Array]"===Object.prototype.toString.call(a)}),p.prototype.beforeDatasetsUpdate=function(a,c){this.parseOptions(a,c);if("outside"===this.position){var b=1.5*this.fontSize+this.outsidePadding;a.chartArea.top+=b;a.chartArea.bottom-=b}},p.prototype.afterDatasetsDraw=function(a,c){this.parseOptions(a,c);this.labelBounds=[];a.config.data.datasets.forEach(this.drawDataset)},p.prototype.drawDataset=function(a){for(var c=this.ctx,b=this.chartInstance,g=a._meta[Object.keys(a._meta)[0]],
k=0,h=0;h<g.data.length;h++){var e=g.data[h],d=e._view;if(0!==d.circumference||this.showZero){switch(this.render){case "value":var f=a.data[h];this.format&&(f=this.format(f));f=f.toString();break;case "label":f=b.config.data.labels[h];break;case "image":f=this.images[h]?this.loadImage(this.images[h]):"";break;default:var n=d.circumference/this.options.circumference*100;n=parseFloat(n.toFixed(this.precision));this.showActualPercentages||(k+=n,100<k&&(n-=k-100,n=parseFloat(n.toFixed(this.precision))));
f=n+"%"}"function"===typeof this.render&&(f=this.render({label:b.config.data.labels[h],value:a.data[h],percentage:n,dataset:a,index:h}),"object"===typeof f&&(f=this.loadImage(f)));if(f){c.save();c.beginPath();c.font=Chart.helpers.fontString(this.fontSize,this.fontStyle,this.fontFamily);if("outside"===this.position||"border"===this.position){var l=d.outerRadius/2;var m=this.fontSize+this.textMargin;var q=d.startAngle+(d.endAngle-d.startAngle)/2;if("border"===this.position)var p=(d.outerRadius-l)/2+
l;else"outside"===this.position&&(this.arc||(m=this.textMargin),p=d.outerRadius-l+l+m);q={x:d.x+Math.cos(q)*p,y:d.y+Math.sin(q)*p};if("outside"===this.position){this.arc||(m+=this.measureText(f).width/2);q.x=q.x<d.x?q.x-m:q.x+m;var t=d.outerRadius+m}}else l=d.innerRadius,q=e.tooltipPosition();m=this.fontColor;"function"===typeof m?m=m({label:b.config.data.labels[h],value:a.data[h],percentage:n,text:f,backgroundColor:a.backgroundColor[h],dataset:a,index:h}):"string"!==typeof m&&(m=m[h]||this.options.defaultFontColor);
if(this.arc)t||(t=(l+d.outerRadius)/2),c.fillStyle=m,c.textBaseline="middle",this.drawArcText(f,t,d,this.overlap);else{var r=this.measureText(f);d=q.x-r.width/2;l=q.x+r.width/2;var u=q.y-r.height/2;r=q.y+r.height/2;(this.overlap||("outside"===this.position?this.checkTextBound(d,l,u,r):e.inRange(d,u)&&e.inRange(d,r)&&e.inRange(l,u)&&e.inRange(l,r)))&&this.fillText(f,q,m)}c.restore()}}}},p.prototype.parseOptions=function(a,c){var b=a.options.pieceLabel;Array.isArray(b)&&(b=b[c]);this.chartInstance=
a;this.ctx=a.chart.ctx;this.options=a.config.options;this.render=b.render||b.mode;this.position=b.position||"default";this.arc=b.arc;this.format=b.format;this.precision=b.precision||0;this.fontSize=b.fontSize||this.options.defaultFontSize;this.fontColor=b.fontColor||this.options.defaultFontColor;this.fontStyle=b.fontStyle||this.options.defaultFontStyle;this.fontFamily=b.fontFamily||this.options.defaultFontFamily;this.shadowOffsetX=b.shadowOffsetX||3;this.shadowOffsetY=b.shadowOffsetY||3;this.shadowColor=
b.shadowColor||"rgba(0,0,0,0.3)";this.shadowBlur=b.shadowBlur||6;this.textShadow=b.textShadow||!1;this.hasTooltip=a.tooltip._active&&a.tooltip._active.length;this.showZero=b.showZero;this.overlap=b.overlap;this.images=b.images||[];this.outsidePadding=b.outsidePadding||2;this.textMargin=b.textMargin||2;this.showActualPercentages=b.showActualPercentages||!1},p.prototype.checkTextBound=function(a,c,b,g){for(var k=this.labelBounds,h=0;h<k.length;++h){for(var e=k[h],d=[[a,b],[a,g],[c,b],[c,g]],f=0;f<d.length;++f){var n=
d[f][0],l=d[f][1];if(n>=e.left&&n<=e.right&&l>=e.top&&l<=e.bottom)return!1}d=[[e.left,e.top],[e.left,e.bottom],[e.right,e.top],[e.right,e.bottom]];for(f=0;f<d.length;++f)if(n=d[f][0],l=d[f][1],n>=a&&n<=c&&l>=b&&l<=g)return!1}k.push({left:a,right:c,top:b,bottom:g});return!0},p.prototype.measureText=function(a){if("object"===typeof a)return{width:a.width,height:a.height};var c=0;a=a.split("\n");for(var b=0;b<a.length;++b){var g=this.ctx.measureText(a[b]);g.width>c&&(c=g.width)}return{width:c,height:this.fontSize*
a.length}},p.prototype.fillText=function(a,c,b){var g=this.ctx;if("object"===typeof a)g.drawImage(a,c.x-a.width/2,c.y-a.height/2,a.width,a.height);else{g.save();g.fillStyle=b;g.textBaseline="top";g.textAlign="center";this.textShadow&&(g.shadowOffsetX=this.shadowOffsetX,g.shadowOffsetY=this.shadowOffsetY,g.shadowColor=this.shadowColor,g.shadowBlur=this.shadowBlur);a=a.split("\n");for(b=0;b<a.length;b++)g.fillText(a[b],c.x,c.y-this.fontSize/2*a.length+this.fontSize*b);g.restore()}},p.prototype.loadImage=
function(a){var c=new Image;c.src=a.src;c.width=a.width;c.height=a.height;return c},p.prototype.drawArcText=function(a,c,b,g){var k=this.ctx,h=b.x,e=b.y,d=b.startAngle;b=b.endAngle;k.save();k.translate(h,e);e=b-d;d+=Math.PI/2;b+=Math.PI/2;var f=d;h=this.measureText(a);d+=(b-(h.width/c+d))/2;if(g||!(b-d>e))if("string"===typeof a){k.rotate(d);a=a.split("\n");g=0;d=[];b=0;"border"===this.position&&(b=(a.length-1)*this.fontSize/2);for(e=0;e<a.length;++e)h=k.measureText(a[e]),h.width>g&&(g=h.width),d.push(h.width);
for(e=0;e<a.length;++e){f=a[e];var n=(a.length-1-e)*-this.fontSize+b;k.save();k.rotate((g-d[e])/2/c);for(var l=0;l<f.length;l++){var m=f.charAt(l);h=k.measureText(m);k.save();k.translate(0,-1*c);k.fillText(m,0,n);k.restore();k.rotate(h.width/c)}k.restore()}}else k.rotate((f+b)/2),k.translate(0,-1*c),this.fillText(a,{x:0,y:0});k.restore()},Chart.pluginService.register({beforeDatasetsUpdate:function(a){v(a,"beforeDatasetsUpdate")},afterDatasetsDraw:function(a){v(a,"afterDatasetsDraw")}}))})();
